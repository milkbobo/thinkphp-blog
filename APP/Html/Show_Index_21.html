<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>Document</title>
	<link rel="stylesheet" href="/blog/Public/Css/common.css" />
	<script type="text/JavaScript" src='/blog/Public/Js/jquery-1.7.2.min.js'></script>
	<script type="text/JavaScript" src='/blog/Public/Js/common.js'></script>
<link rel="stylesheet" href="/blog/Public/Css/show.css" />
<link rel="stylesheet" href="/blog/Data/Ueditor/third-party/SyntaxHighlighter/shCoreDefault.css" />
<script type="text/javascript" src='/blog/Data/Ueditor/third-party/SyntaxHighlighter/shCore.js'></script>
<script  type="text/javascript">
SyntaxHighlighter.all();
</script>

</head>

<body>
    <!--头部-->
    <div class='top-list-wrap'>
        <div class='top-list'>
            <ul class='l-list'>
                <li><a href="http://www.houdunwang.com" target='_blank'>后盾网</a>
                </li>
                <li><a href="http://bbs.houdunwang.com" target='_blank'>后盾网论坛</a>
                </li>
                <li><a href="http://study.houdunwang.com" target='_blank'>后盾学习社区</a>
                </li>
            </ul>
            <ul class='r-list'>
                <li><a href="http://www.hdphp.com" target='_blank'>HDPHP框架</a>
                </li>
                <li><a href="http://bbs.houdunwang.com" target='_blank'>免费视频教程</a>
                </li>
            </ul>
        </div>
    </div>


    <div class='top-search-wrap'>
        <div class='top-search'>
            <a href="http://bbs.houdunwang.com" target='_blank' class='logo'>
                <img src="/blog/Public/Images/logo.png" />
            </a>
            <div class='search-wrap'>
                <form action="" method='get'>
                    <input type="text" name='keyword' class='search-content' />
                    <input type="submit" name='search' value='搜索' />
                </form>
            </div>
        </div>
    </div>




    <div class='top-nav-wrap'>
        <ul class='nav-lv1'>
            <li class='nav-lv1-li'>
                <a href="/blog" class='top-cate'>博客首页</a>
            </li>

            <li class='nav-lv1-li'>
                    <a href="/blog/c_1.html" class='top-cate'>HTML</a>
                    <ul>
                                        </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_2.html" class='top-cate'>DIV+CSS</a>
                    <ul>
                                        </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_3.html" class='top-cate'>JavaScript</a>
                    <ul>
                    <li><a href="/blog/c_8.html">JQuery</a>
                            </li><li><a href="/blog/c_9.html">Ajax</a>
                            </li>                    </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_4.html" class='top-cate'>PHP</a>
                    <ul>
                    <li><a href="/blog/c_10.html">字符串</a>
                            </li><li><a href="/blog/c_11.html">数组</a>
                            </li><li><a href="/blog/c_12.html">对象</a>
                            </li>                    </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_5.html" class='top-cate'>MySQL</a>
                    <ul>
                    <li><a href="/blog/c_16.html">存储引擎</a>
                            </li><li><a href="/blog/c_14.html">事务</a>
                            </li><li><a href="/blog/c_15.html">视图</a>
                            </li><li><a href="/blog/c_13.html">存储引擎</a>
                            </li>                    </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_6.html" class='top-cate'>Linux</a>
                    <ul>
                    <li><a href="/blog/c_17.html">基本命令</a>
                            </li><li><a href="/blog/c_18.html">网络配置</a>
                            </li>                    </ul>
                </li><li class='nav-lv1-li'>
                    <a href="/blog/c_7.html" class='top-cate'>其他</a>
                    <ul>
                                        </ul>
                </li>
        </ul>
    </div>

<div class='main'>
    <div class='main-left'>
        <div class='location'>
            <a href="">首页</a>
            ><a href="/blog/c_4.html">PHP</a>><a href="/blog/c_11.html">数组</a>            
        </div>
        <div class="title">
            <p>php</p>
            <div>
                <span class='fl'>发布于：2014年Nov月Fri日</span>
                <span class='fr'>已被阅读<script src='/blog/Index/Show/clickNum/id/21.html'></script>次</span>
            </div>
        </div>
        <div class='content' style="word-break:break-all">
            <pre class="brush:php;toolbar:false">&lt;?php
class&nbsp;BlogAction&nbsp;extends&nbsp;CommonAction{
	//博文列表
	public&nbsp;function&nbsp;index(){
		//$field=array(&#39;id&#39;,&#39;title&#39;,&#39;content&#39;,&#39;time&#39;,&#39;click&#39;);//field($field)需要的字段
//&nbsp;		$field=array(&#39;del&#39;);//field($field,true)不需要的字段
//&nbsp;		$where=array(&#39;del&#39;=&gt;0);
//&nbsp;		$this-&gt;blog=D(&#39;BlogRelation&#39;)-&gt;field($field,true)-&gt;where($where)-&gt;relation(true)-&gt;select();
		$this-&gt;blog=D(&#39;BlogRelation&#39;)-&gt;getBlogs();
		$this-&gt;display();
	}
	
	//删除到回收站或还原
	public&nbsp;function&nbsp;toTrach(){
		$type=I(&#39;type&#39;);
		$update=array(&#39;id&#39;=&gt;I(&#39;id&#39;),&#39;del&#39;=&gt;$type);
		$msg=$type?&#39;删除&#39;:&#39;还原&#39;;
		//M(&#39;blog&#39;)-&gt;where(array(&#39;id&#39;=&gt;I(&#39;id&#39;)))-&gt;save($update);
		//M(&#39;blog&#39;)-&gt;where(array(&#39;id&#39;=&gt;I(&#39;id&#39;)))-&gt;setField(&#39;del&#39;,1);//单独修改
		if&nbsp;(M(&#39;blog&#39;)-&gt;save($update)){
			$this-&gt;success($msg.&#39;成功&#39;,U(GROUP_NAME.&#39;/Blog/index&#39;));
		}else&nbsp;{
			$this-&gt;error($msg.&#39;失败&#39;);
		}
		
	}
	
	//回收站
	public&nbsp;function&nbsp;trach(){
		$this-&gt;blog=D(&#39;BlogRelation&#39;)-&gt;getBlogs(1);
		$this-&gt;display(&#39;index&#39;);
	}
	
	public&nbsp;function&nbsp;delete(){
		$id=I(&#39;id&#39;);
		//D(&#39;BlogRelation&#39;)-&gt;relation(&#39;attr&#39;)-&gt;delete($id);//D方法删除出现bug,把中间表全部内容也删除了。
		if&nbsp;(M(&#39;blog&#39;)-&gt;delete($id)){
			M(&#39;blog_attr&#39;)-&gt;where(array(&#39;bid&#39;=&gt;$id))-&gt;delete();
			$this-&gt;success(&#39;删除成功&#39;,U(GROUP_NAME.&#39;/Blog/trach&#39;));
		}else&nbsp;{
			$this-&gt;error(&#39;删除失败&#39;);
		}
		//$this-&gt;display(index);//调试模式要调出模板才可以使用
	}
	
	//清空回收站全部文章
	public&nbsp;function&nbsp;deleteAll(){
		$del=M(&#39;blog&#39;)-&gt;where(&#39;del=1&#39;)-&gt;getField(&#39;id&#39;,true);
			if&nbsp;($del){
				foreach&nbsp;($del&nbsp;as&nbsp;$v){
					M(&#39;blog&#39;)-&gt;delete($v);
					M(&#39;blog_attr&#39;)-&gt;where(array(bid=&gt;$v))-&gt;delete();	
				}
				$this-&gt;success(&#39;删除成功&#39;,U(GROUP_NAME.&#39;/Blog/trach&#39;));
			}else&nbsp;{
				$this-&gt;error(&#39;删除失败&#39;);
					}
	}

	
	//添加博文
	public&nbsp;function&nbsp;blog(){
		import(&#39;Class.Category&#39;,APP_PATH);
		$cate=M(&#39;cate&#39;)-&gt;order(&#39;sort&#39;)-&gt;select();
		$this-&gt;cate=Category::unlimitedForLever($cate);
		//博文属性
		$this-&gt;attr=M(&#39;attr&#39;)-&gt;select();
		$this-&gt;display();
	}
	//添加博文表单处理
	public&nbsp;function&nbsp;addBlog(){
		//D(&#39;BlogRelation&#39;);//D方法添加，中介表出问题（全部删除再添加），暂时不能用。
		//p($_POST);
		$data=array(
		&#39;title&#39;=&gt;I(&#39;title&#39;),
		//&#39;content&#39;=&gt;$_POST[&#39;content&#39;],
		&#39;content&#39;=&gt;I(&#39;content&#39;,&#39;&#39;,&#39;&#39;),//修复为不用转义html
		&#39;summary&#39;=&gt;I(&#39;summary&#39;),
		&#39;time&#39;=&gt;time(),
		//&#39;click&#39;=&gt;(int)$_POST[&#39;click&#39;],
		&#39;click&#39;=&gt;I(&#39;click&#39;),
		//&#39;cid&#39;=&gt;(int)$_POST[&#39;cid&#39;],
		&#39;cid&#39;=&gt;I(&#39;cid&#39;),
		);
//&nbsp;		if&nbsp;(isset($_POST[&#39;aid&#39;])){
//&nbsp;			foreach&nbsp;($_POST[&#39;aid&#39;]&nbsp;as&nbsp;$v){
//&nbsp;				$data[&#39;attr&#39;][]=$v;
//&nbsp;			}
//&nbsp;		}
//&nbsp;		D(&#39;BlogRelation&#39;)-&gt;relation(true)-&gt;add($data);&nbsp;

//用sql来实现增加blog_attr信息
//&nbsp;		if($bid&nbsp;=&nbsp;M(&#39;blog&#39;)&nbsp;-&gt;&nbsp;add($data)&nbsp;){
//&nbsp;			if&nbsp;(isset($_POST[&#39;aid&#39;])){
//&nbsp;				$sql&nbsp;=&nbsp;&#39;INSERT&nbsp;INTO&nbsp;`&#39;.C(&#39;DB_PREFIX&#39;).&#39;blog_attr`&nbsp;(bid,aid)&nbsp;VALUES&#39;;
//&nbsp;				foreach&nbsp;($_POST[&#39;aid&#39;]&nbsp;as&nbsp;$v){
//&nbsp;					$sql.=&#39;(&#39;.$bid.&#39;,&#39;.$v.&#39;),&#39;;
//&nbsp;				}
//&nbsp;				$sql=rtrim($sql,&#39;,&#39;);
//&nbsp;				M(&#39;blog_attr&#39;)-&gt;query($sql);
//&nbsp;			}$this-&gt;success(&#39;提交成功&#39;,U(GROUP_NAME.&#39;/Blog/index&#39;));
//&nbsp;		}else&nbsp;{
//&nbsp;			$this-&gt;error(&#39;添加失败&#39;);
//&nbsp;		}

		//think方法多维提交（自己编写的）
				if($bid&nbsp;=&nbsp;M(&#39;blog&#39;)&nbsp;-&gt;&nbsp;add($data)&nbsp;){
					if&nbsp;(isset($_POST[&#39;aid&#39;])){
						$sql=array();
						foreach&nbsp;($_POST[&#39;aid&#39;]&nbsp;as&nbsp;$v){
							$sql[]=array(&#39;bid&#39;=&gt;$bid,&#39;aid&#39;=&gt;$v);
						}
						M(&#39;blog_attr&#39;)-&gt;addAll($sql);
						}$this-&gt;success(&#39;提交成功&#39;,U(GROUP_NAME.&#39;/Blog/index&#39;));
					}else&nbsp;{
						$this-&gt;error(&#39;添加失败&#39;);
				}
				
	}
	

}


?&gt;</pre><p><br/></p>        </div>
    </div>
    <!--主体右侧-->
    <div class='main-right'>
    			<dl>
			
				<dt>热门博文</dt>
				<dd>
					<a href="/blog/15.html" target="_blank">44444444444444444</a>
					<span>289</span>
				</dd><dd>
					<a href="/blog/13.html" target="_blank">23452345</a>
					<span>155</span>
				</dd><dd>
					<a href="/blog/14.html" target="_blank">5234523</a>
					<span>155</span>
				</dd><dd>
					<a href="/blog/21.html" target="_blank">php</a>
					<span>155</span>
				</dd><dd>
					<a href="/blog/17.html" target="_blank">asdfasd23</a>
					<span>155</span>
				</dd>			</dl>    <dl>
        <dt>热门博文</dt>
        <dd>
                <a href="/blog/15.html">44444444444444444</a>
                <span>289</span>
            </dd><dd>
                <a href="/blog/13.html">23452345</a>
                <span>155</span>
            </dd><dd>
                <a href="/blog/14.html">5234523</a>
                <span>155</span>
            </dd><dd>
                <a href="/blog/21.html">php</a>
                <span>155</span>
            </dd><dd>
                <a href="/blog/17.html">asdfasd23</a>
                <span>155</span>
            </dd>    </dl>

    <dl>
    <dt>最发布发</dt>
    <dd>
            <a href="/blog/21.html">php</a>
            <span>(155)</span>
        </dd><dd>
            <a href="/blog/20.html">12312</a>
            <span>(155)</span>
        </dd><dd>
            <a href="/blog/19.html">分享</a>
            <span>(155)</span>
        </dd><dd>
            <a href="/blog/18.html">12341</a>
            <span>(155)</span>
        </dd><dd>
            <a href="/blog/17.html">asdfasd23</a>
            <span>(155)</span>
        </dd></dl>

    <dl>
        <dt>友情连接</dt>
       <dd>
            <a href="http://www.weiyd.cn">Edward2</a>
        </dd><dd>
            <a href="http://www.weiyd.cn3">weiyd3</a>
        </dd>
    </dl>
</div>
</div>
<!--底部-->
<!--底部-->
	<div class='bottom'>
		<div></div>
	</div>
</body>
</html>